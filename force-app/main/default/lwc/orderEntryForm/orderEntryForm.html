<template>
    <lightning-card title="Order Entry" icon-name="standard:orders">
        <!-- Account/Outlet Selector -->
        <div class="slds-p-around_medium">
            <template if:false={recordId}>
                <div class="slds-grid slds-gutters slds-m-bottom_medium">
                    <div class="slds-col slds-size_1-of-2">
                        <lightning-record-picker
                            label="Select Outlet"
                            placeholder="Search outlet..."
                            object-api-name="Account"
                            value={selectedAccountId}
                            onchange={handleAccountChange}>
                        </lightning-record-picker>
                    </div>
                </div>
            </template>

            <template if:true={accountName}>
                <div class="outlet-header slds-m-bottom_medium">
                    <div class="slds-grid slds-grid_align-spread">
                        <div class="slds-col">
                            <h2 class="slds-text-heading_medium">{accountName}</h2>
                            <p class="slds-text-body_small slds-text-color_weak">{accountChannel} &bull; {accountClass}</p>
                        </div>
                        <div class="slds-col slds-text-align_right">
                            <template if:true={lastOrderInfo}>
                                <lightning-button
                                    variant="brand-outline"
                                    label="Reorder from Last Order"
                                    icon-name="utility:refresh"
                                    onclick={handleReorderLastOrder}
                                    class="slds-m-right_x-small">
                                </lightning-button>
                            </template>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Last Order Info -->
            <template if:true={lastOrderInfo}>
                <div class="last-order-banner slds-m-bottom_medium">
                    <lightning-icon icon-name="utility:info_alt" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                    <span class="slds-text-body_small">
                        Last Order: #{lastOrderInfo.orderNumber} on {lastOrderInfo.orderDate} -
                        {lastOrderInfo.itemCount} items worth {lastOrderInfo.totalFormatted}
                    </span>
                </div>
            </template>

            <!-- Product Search Section -->
            <div class="product-search-section slds-m-bottom_medium">
                <h3 class="slds-text-heading_small slds-m-bottom_small">Search Products</h3>
                <div class="slds-grid slds-gutters">
                    <div class="slds-col slds-size_1-of-2">
                        <lightning-input
                            type="search"
                            label="Search by Product Name or SKU"
                            placeholder="Type product name, SKU, or category..."
                            value={searchTerm}
                            onchange={handleSearchTermChange}>
                        </lightning-input>
                    </div>
                    <div class="slds-col slds-size_1-of-4">
                        <lightning-combobox
                            label="Category"
                            value={selectedCategory}
                            options={categoryOptions}
                            placeholder="All Categories"
                            onchange={handleCategoryChange}>
                        </lightning-combobox>
                    </div>
                    <div class="slds-col slds-size_1-of-4 search-btn-wrapper">
                        <lightning-button
                            variant="brand"
                            label="Search"
                            icon-name="utility:search"
                            onclick={handleProductSearch}>
                        </lightning-button>
                    </div>
                </div>
            </div>

            <!-- Product Results Table -->
            <template if:true={showProductResults}>
                <div class="product-results slds-m-bottom_medium">
                    <h3 class="slds-text-heading_small slds-m-bottom_small">
                        Search Results ({productResults.length} products found)
                    </h3>
                    <div class="slds-scrollable_y product-table-container">
                        <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_striped">
                            <thead>
                                <tr class="slds-line-height_reset">
                                    <th scope="col"><div class="slds-truncate">Product Name</div></th>
                                    <th scope="col"><div class="slds-truncate">SKU</div></th>
                                    <th scope="col"><div class="slds-truncate">MRP</div></th>
                                    <th scope="col" class="qty-col"><div class="slds-truncate">Qty</div></th>
                                    <th scope="col" class="qty-col"><div class="slds-truncate">Free Qty</div></th>
                                    <th scope="col"><div class="slds-truncate">Scheme</div></th>
                                    <th scope="col"><div class="slds-truncate">Line Total</div></th>
                                    <th scope="col"><div class="slds-truncate">Action</div></th>
                                </tr>
                            </thead>
                            <tbody>
                                <template for:each={productResults} for:item="product">
                                    <tr key={product.id}>
                                        <td>
                                            <div class="slds-truncate" title={product.name}>{product.name}</div>
                                            <span class="slds-text-body_small slds-text-color_weak">{product.category}</span>
                                        </td>
                                        <td><div class="slds-truncate">{product.sku}</div></td>
                                        <td><div class="slds-truncate">{product.mrpFormatted}</div></td>
                                        <td class="qty-col">
                                            <lightning-input
                                                type="number"
                                                min="0"
                                                value={product.quantity}
                                                data-product-id={product.id}
                                                data-field="quantity"
                                                variant="label-hidden"
                                                onchange={handleProductQtyChange}>
                                            </lightning-input>
                                        </td>
                                        <td class="qty-col">
                                            <span class="free-qty-badge">{product.freeQty}</span>
                                        </td>
                                        <td>
                                            <template if:true={product.schemeName}>
                                                <lightning-badge label={product.schemeName} class="scheme-badge"></lightning-badge>
                                            </template>
                                            <template if:false={product.schemeName}>
                                                <span class="slds-text-color_weak">None</span>
                                            </template>
                                        </td>
                                        <td><div class="slds-truncate line-total">{product.lineTotalFormatted}</div></td>
                                        <td>
                                            <lightning-button-icon
                                                icon-name="utility:add"
                                                alternative-text="Add to cart"
                                                variant="brand"
                                                data-product-id={product.id}
                                                onclick={addToOrder}>
                                            </lightning-button-icon>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </template>

            <!-- Order Line Items (Cart) -->
            <template if:true={hasLineItems}>
                <div class="order-cart slds-m-bottom_medium">
                    <div class="cart-header slds-grid slds-grid_align-spread slds-m-bottom_small">
                        <h3 class="slds-text-heading_small">
                            <lightning-icon icon-name="utility:cart" size="small" class="slds-m-right_x-small"></lightning-icon>
                            Order Items ({lineItemCount})
                        </h3>
                        <lightning-button
                            variant="text-destructive"
                            label="Clear All"
                            icon-name="utility:delete"
                            onclick={handleClearCart}>
                        </lightning-button>
                    </div>
                    <div class="slds-scrollable_y cart-table-container">
                        <table class="slds-table slds-table_cell-buffer slds-table_bordered">
                            <thead>
                                <tr class="slds-line-height_reset">
                                    <th scope="col"><div class="slds-truncate">#</div></th>
                                    <th scope="col"><div class="slds-truncate">Product</div></th>
                                    <th scope="col"><div class="slds-truncate">SKU</div></th>
                                    <th scope="col"><div class="slds-truncate">Rate</div></th>
                                    <th scope="col" class="qty-col"><div class="slds-truncate">Qty</div></th>
                                    <th scope="col" class="qty-col"><div class="slds-truncate">Free</div></th>
                                    <th scope="col"><div class="slds-truncate">Scheme</div></th>
                                    <th scope="col"><div class="slds-truncate">Discount</div></th>
                                    <th scope="col"><div class="slds-truncate">Tax</div></th>
                                    <th scope="col"><div class="slds-truncate">Total</div></th>
                                    <th scope="col"><div class="slds-truncate">Action</div></th>
                                </tr>
                            </thead>
                            <tbody>
                                <template for:each={lineItems} for:item="item" for:index="index">
                                    <tr key={item.id} class={item.rowClass}>
                                        <td>{item.serialNumber}</td>
                                        <td>
                                            <div class="slds-truncate" title={item.productName}>{item.productName}</div>
                                        </td>
                                        <td><div class="slds-truncate">{item.sku}</div></td>
                                        <td>{item.rateFormatted}</td>
                                        <td class="qty-col">
                                            <lightning-input
                                                type="number"
                                                min="1"
                                                value={item.quantity}
                                                data-line-id={item.id}
                                                data-field="quantity"
                                                variant="label-hidden"
                                                onchange={handleLineQtyChange}>
                                            </lightning-input>
                                        </td>
                                        <td class="qty-col">
                                            <span class="free-qty-badge">{item.freeQty}</span>
                                        </td>
                                        <td>
                                            <template if:true={item.schemeName}>
                                                <lightning-badge label={item.schemeName}></lightning-badge>
                                            </template>
                                        </td>
                                        <td>{item.discountFormatted}</td>
                                        <td>{item.taxFormatted}</td>
                                        <td class="line-total-cell">{item.totalFormatted}</td>
                                        <td>
                                            <lightning-button-icon
                                                icon-name="utility:delete"
                                                alternative-text="Remove"
                                                variant="bare"
                                                data-line-id={item.id}
                                                onclick={removeLineItem}
                                                class="delete-btn">
                                            </lightning-button-icon>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </template>

            <!-- Order Summary -->
            <template if:true={hasLineItems}>
                <div class="order-summary">
                    <h3 class="slds-text-heading_small slds-m-bottom_small">Order Summary</h3>
                    <div class="summary-card">
                        <div class="slds-grid slds-grid_align-end">
                            <div class="slds-col slds-size_1-of-3">
                                <div class="summary-row">
                                    <span class="summary-label">Gross Amount:</span>
                                    <span class="summary-value">{orderSummary.grossAmountFormatted}</span>
                                </div>
                                <div class="summary-row discount-row">
                                    <span class="summary-label">Discount (-):</span>
                                    <span class="summary-value discount-value">{orderSummary.totalDiscountFormatted}</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Taxable Amount:</span>
                                    <span class="summary-value">{orderSummary.taxableAmountFormatted}</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Tax (GST):</span>
                                    <span class="summary-value">{orderSummary.totalTaxFormatted}</span>
                                </div>
                                <div class="summary-row total-row">
                                    <span class="summary-label">Net Amount:</span>
                                    <span class="summary-value net-amount">{orderSummary.netAmountFormatted}</span>
                                </div>
                                <div class="summary-row items-row">
                                    <span class="summary-label">Total Items:</span>
                                    <span class="summary-value">{orderSummary.totalItems}</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Total Quantity:</span>
                                    <span class="summary-value">{orderSummary.totalQuantity}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Remarks -->
            <template if:true={hasLineItems}>
                <div class="slds-m-top_medium slds-m-bottom_medium">
                    <lightning-textarea
                        label="Order Remarks"
                        value={orderRemarks}
                        placeholder="Add any special instructions or notes..."
                        onchange={handleRemarksChange}
                        max-length="500">
                    </lightning-textarea>
                </div>
            </template>

            <!-- Action Buttons -->
            <template if:true={hasLineItems}>
                <div class="action-buttons slds-m-top_medium">
                    <div class="slds-grid slds-grid_align-center slds-gutters">
                        <div class="slds-col">
                            <lightning-button
                                variant="neutral"
                                label="Save Draft"
                                icon-name="utility:save"
                                onclick={handleSaveDraft}
                                disabled={isSubmitting}>
                            </lightning-button>
                        </div>
                        <div class="slds-col">
                            <lightning-button
                                variant="brand"
                                label="Submit Order"
                                icon-name="utility:check"
                                onclick={handleSubmitOrder}
                                disabled={isSubmitting}>
                            </lightning-button>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Spinner -->
            <template if:true={isLoading}>
                <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
            </template>
        </div>
    </lightning-card>
</template>