<template>
    <template if:true={isLoading}>
        <lightning-spinner alternative-text="Loading" size="large" class="slds-is-fixed"></lightning-spinner>
    </template>

    <lightning-card title="Stock Transfers" icon-name="standard:shipment">
        <div slot="actions">
            <template if:true={isListView}>
                <lightning-button label="New Transfer" variant="brand" icon-name="utility:add" onclick={handleNewTransfer}></lightning-button>
            </template>
            <template if:false={isListView}>
                <lightning-button label="Back to List" variant="neutral" icon-name="utility:back" onclick={handleBackToList}></lightning-button>
            </template>
        </div>

        <div class="slds-p-around_medium">
            <!-- Error Banner -->
            <template if:true={errorMessage}>
                <div class="slds-notify slds-notify_alert slds-alert_error slds-m-bottom_medium" role="alert">
                    <lightning-icon icon-name="utility:error" size="x-small" variant="inverse" class="slds-m-right_x-small"></lightning-icon>
                    <h2>{errorMessage}</h2>
                </div>
            </template>

            <!-- LIST VIEW -->
            <template if:true={isListView}>
                <div class="slds-grid slds-gutters_small slds-wrap slds-m-bottom_small">
                    <div class="slds-col slds-size_1-of-1 slds-medium-size_4-of-12 slds-p-bottom_x-small">
                        <lightning-combobox name="filterWarehouse" label="Warehouse" value={filterWarehouseId} options={filterWarehouseOptions} onchange={handleFilterWarehouseChange}></lightning-combobox>
                    </div>
                    <div class="slds-col slds-size_1-of-1 slds-medium-size_4-of-12 slds-p-bottom_x-small">
                        <lightning-combobox name="filterStatus" label="Status" value={filterStatus} options={statusFilterOptions} onchange={handleFilterStatusChange}></lightning-combobox>
                    </div>
                </div>

                <template if:true={hasTransfers}>
                    <div class="table-container">
                        <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_striped">
                            <thead>
                                <tr class="slds-line-height_reset">
                                    <th scope="col"><div class="slds-truncate">Transfer #</div></th>
                                    <th scope="col"><div class="slds-truncate">Source</div></th>
                                    <th scope="col"><div class="slds-truncate">Destination</div></th>
                                    <th scope="col"><div class="slds-truncate">Date</div></th>
                                    <th scope="col"><div class="slds-truncate">Status</div></th>
                                    <th scope="col"><div class="slds-truncate">Requested By</div></th>
                                    <th scope="col"><div class="slds-truncate">Action</div></th>
                                </tr>
                            </thead>
                            <tbody>
                                <template for:each={transfers} for:item="row">
                                    <tr key={row.id}>
                                        <td><div class="slds-truncate">{row.name}</div></td>
                                        <td><div class="slds-truncate">{row.sourceName}</div></td>
                                        <td><div class="slds-truncate">{row.destName}</div></td>
                                        <td>{row.transferDate}</td>
                                        <td><lightning-badge label={row.status} class={row.statusClass}></lightning-badge></td>
                                        <td><div class="slds-truncate">{row.requestedBy}</div></td>
                                        <td>
                                            <lightning-button-icon icon-name="utility:preview" alternative-text="View" data-id={row.id} onclick={handleViewTransfer} variant="bare" size="small"></lightning-button-icon>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </template>

                <template if:false={hasTransfers}>
                    <div class="slds-p-around_large slds-text-align_center">
                        <p class="slds-text-body_regular slds-text-color_weak">No stock transfers found.</p>
                    </div>
                </template>
            </template>

            <!-- CREATE VIEW -->
            <template if:true={isCreateView}>
                <div class="slds-grid slds-gutters_small slds-wrap slds-m-bottom_medium">
                    <div class="slds-col slds-size_1-of-1 slds-medium-size_4-of-12 slds-p-bottom_x-small">
                        <lightning-combobox name="sourceWarehouse" label="Source Warehouse" required value={sourceWarehouseId} options={warehouseOptions} onchange={handleSourceWarehouseChange}></lightning-combobox>
                    </div>
                    <div class="slds-col slds-size_1-of-1 slds-medium-size_4-of-12 slds-p-bottom_x-small">
                        <lightning-combobox name="destWarehouse" label="Destination Warehouse" required value={destinationWarehouseId} options={warehouseOptions} onchange={handleDestWarehouseChange}></lightning-combobox>
                    </div>
                    <div class="slds-col slds-size_1-of-1 slds-medium-size_4-of-12 slds-p-bottom_x-small">
                        <lightning-input type="date" label="Transfer Date" value={transferDate} onchange={handleTransferDateChange}></lightning-input>
                    </div>
                </div>

                <lightning-textarea label="Notes" value={transferNotes} onchange={handleTransferNotesChange} class="slds-m-bottom_small"></lightning-textarea>

                <!-- Line Items -->
                <div class="slds-section slds-is-open slds-m-bottom_small">
                    <h3 class="slds-section__title">
                        <span class="slds-text-heading_small">Line Items</span>
                    </h3>
                </div>

                <template if:true={hasLineItems}>
                    <template for:each={lineItems} for:item="line">
                        <div key={line.key} class="slds-grid slds-gutters_x-small slds-wrap slds-m-bottom_x-small slds-p-around_x-small slds-box">
                            <div class="slds-col slds-size_5-of-12">
                                <lightning-combobox name="lineProduct" label="Product" value={line.productId} options={productOptions} data-key={line.key} onchange={handleLineProductChange}></lightning-combobox>
                            </div>
                            <div class="slds-col slds-size_3-of-12">
                                <lightning-input type="number" label="Quantity" value={line.requestedQty} min="1" data-key={line.key} onchange={handleLineQtyChange}></lightning-input>
                            </div>
                            <div class="slds-col slds-size_2-of-12 slds-grid slds-grid_vertical-align-end">
                                <lightning-button-icon icon-name="utility:delete" alternative-text="Remove" data-key={line.key} onclick={handleRemoveLine} variant="bare" size="medium"></lightning-button-icon>
                            </div>
                        </div>
                    </template>
                </template>

                <lightning-button label="Add Line Item" variant="neutral" icon-name="utility:add" onclick={handleAddLine} class="slds-m-bottom_medium"></lightning-button>

                <div class="slds-grid slds-grid_align-end slds-m-top_medium">
                    <lightning-button label="Cancel" variant="neutral" onclick={handleCancelCreate} class="slds-m-right_small"></lightning-button>
                    <lightning-button label="Create Transfer" variant="brand" onclick={handleSaveTransfer}></lightning-button>
                </div>
            </template>

            <!-- DETAIL VIEW -->
            <template if:true={isDetailView}>
                <template if:true={detailTransfer}>
                    <div class="slds-grid slds-wrap slds-gutters_small slds-m-bottom_medium">
                        <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4 slds-p-bottom_small">
                            <p class="slds-text-title_caps">Transfer #</p>
                            <p class="slds-text-body_regular"><strong>{detailTransfer.name}</strong></p>
                        </div>
                        <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4 slds-p-bottom_small">
                            <p class="slds-text-title_caps">Status</p>
                            <p class="slds-text-body_regular"><lightning-badge label={detailTransfer.status}></lightning-badge></p>
                        </div>
                        <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4 slds-p-bottom_small">
                            <p class="slds-text-title_caps">Source</p>
                            <p class="slds-text-body_regular">{detailTransfer.sourceName}</p>
                        </div>
                        <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4 slds-p-bottom_small">
                            <p class="slds-text-title_caps">Destination</p>
                            <p class="slds-text-body_regular">{detailTransfer.destName}</p>
                        </div>
                        <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4 slds-p-bottom_small">
                            <p class="slds-text-title_caps">Transfer Date</p>
                            <p class="slds-text-body_regular">{detailTransfer.transferDate}</p>
                        </div>
                        <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4 slds-p-bottom_small">
                            <p class="slds-text-title_caps">Requested By</p>
                            <p class="slds-text-body_regular">{detailTransfer.requestedBy}</p>
                        </div>
                    </div>

                    <!-- Line Items Table -->
                    <div class="table-container slds-m-bottom_medium">
                        <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_striped">
                            <thead>
                                <tr class="slds-line-height_reset">
                                    <th scope="col"><div class="slds-truncate">Line #</div></th>
                                    <th scope="col"><div class="slds-truncate">Product</div></th>
                                    <th scope="col"><div class="slds-truncate">Code</div></th>
                                    <th scope="col" class="slds-text-align_right"><div class="slds-truncate">Requested</div></th>
                                    <th scope="col" class="slds-text-align_right"><div class="slds-truncate">Approved</div></th>
                                    <th scope="col" class="slds-text-align_right"><div class="slds-truncate">Received</div></th>
                                    <th scope="col" class="slds-text-align_right"><div class="slds-truncate">Short</div></th>
                                    <th scope="col" class="slds-text-align_right"><div class="slds-truncate">Available (Snapshot)</div></th>
                                </tr>
                            </thead>
                            <tbody>
                                <template for:each={detailLineItems} for:item="line">
                                    <tr key={line.id}>
                                        <td>{line.name}</td>
                                        <td><div class="slds-truncate">{line.productName}</div></td>
                                        <td><div class="slds-truncate">{line.productCode}</div></td>
                                        <td class="slds-text-align_right">{line.requestedQty}</td>
                                        <td class="slds-text-align_right">{line.approvedQty}</td>
                                        <td class="slds-text-align_right">{line.receivedQty}</td>
                                        <td class="slds-text-align_right">{line.shortQty}</td>
                                        <td class="slds-text-align_right">{line.availableStock}</td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                    <!-- Actions -->
                    <div class="slds-grid slds-grid_align-end">
                        <template if:true={canSubmit}>
                            <lightning-button label="Submit for Approval" variant="brand" onclick={handleSubmitTransfer} class="slds-m-right_small"></lightning-button>
                        </template>
                        <template if:true={canReceive}>
                            <lightning-button label="Receive Transfer" variant="brand" onclick={handleOpenReceiveModal}></lightning-button>
                        </template>
                    </div>
                </template>
            </template>
        </div>
    </lightning-card>

    <!-- Receive Modal -->
    <template if:true={showReceiveModal}>
        <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container">
                <header class="slds-modal__header">
                    <h2 class="slds-text-heading_medium">Receive Transfer</h2>
                </header>
                <div class="slds-modal__content slds-p-around_medium">
                    <p class="slds-m-bottom_small">Enter the received quantities for each line item:</p>
                    <template for:each={receiveLineItems} for:item="line">
                        <div key={line.id} class="slds-grid slds-gutters_small slds-m-bottom_x-small">
                            <div class="slds-col slds-size_6-of-12">
                                <p class="slds-text-body_regular"><strong>{line.productName}</strong></p>
                                <p class="slds-text-body_small">Approved Qty: {line.approvedQty}</p>
                            </div>
                            <div class="slds-col slds-size_6-of-12">
                                <lightning-input type="number" label="Received Qty" value={line.receivedQty} min="0" data-id={line.id} onchange={handleReceiveQtyChange}></lightning-input>
                            </div>
                        </div>
                    </template>
                </div>
                <footer class="slds-modal__footer">
                    <lightning-button label="Cancel" onclick={handleCloseReceiveModal} class="slds-m-right_small"></lightning-button>
                    <lightning-button label="Confirm Receipt" variant="brand" onclick={handleConfirmReceive}></lightning-button>
                </footer>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
</template>
