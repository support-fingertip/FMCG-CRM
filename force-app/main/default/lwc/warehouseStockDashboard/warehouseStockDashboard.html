<template>
    <!-- Loading Spinner -->
    <template if:true={isLoading}>
        <lightning-spinner alternative-text="Loading" size="large" class="slds-is-fixed"></lightning-spinner>
    </template>

    <lightning-card title="Warehouse Stock Dashboard" icon-name="standard:product_item">
        <!-- Top Bar: Warehouse Selector & Refresh -->
        <div slot="actions">
            <div class="slds-grid slds-grid_vertical-align-center slds-gutters_x-small">
                <div class="slds-col" style="min-width: 280px;">
                    <lightning-combobox
                        name="warehouseSelector"
                        label="Warehouse"
                        value={selectedWarehouseId}
                        placeholder="Select Warehouse"
                        options={warehouseOptions}
                        onchange={handleWarehouseChange}
                        variant="label-hidden"
                    ></lightning-combobox>
                </div>
                <div class="slds-col">
                    <lightning-button-icon
                        icon-name="utility:refresh"
                        alternative-text="Refresh"
                        title="Refresh Dashboard"
                        onclick={handleRefresh}
                        variant="border-filled"
                    ></lightning-button-icon>
                </div>
            </div>
        </div>

        <div class="slds-p-around_medium">
            <!-- KPI Cards Row -->
            <div class="slds-grid slds-wrap slds-gutters_small slds-m-bottom_medium">
                <!-- Total SKUs -->
                <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-3 slds-large-size_1-of-6 slds-p-bottom_small">
                    <div class="kpi-card kpi-card_default">
                        <div class="kpi-card__icon">
                            <lightning-icon icon-name="standard:product_item" size="small"></lightning-icon>
                        </div>
                        <div class="kpi-card__content">
                            <p class="kpi-card__value">{kpiTotalSkus}</p>
                            <p class="kpi-card__label">Total SKUs</p>
                        </div>
                    </div>
                </div>

                <!-- On Hand -->
                <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-3 slds-large-size_1-of-6 slds-p-bottom_small">
                    <div class="kpi-card kpi-card_default">
                        <div class="kpi-card__icon">
                            <lightning-icon icon-name="standard:product_required" size="small"></lightning-icon>
                        </div>
                        <div class="kpi-card__content">
                            <p class="kpi-card__value">{kpiTotalOnHand}</p>
                            <p class="kpi-card__label">On Hand</p>
                        </div>
                    </div>
                </div>

                <!-- Reserved -->
                <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-3 slds-large-size_1-of-6 slds-p-bottom_small">
                    <div class="kpi-card kpi-card_default">
                        <div class="kpi-card__icon">
                            <lightning-icon icon-name="standard:record" size="small"></lightning-icon>
                        </div>
                        <div class="kpi-card__content">
                            <p class="kpi-card__value">{kpiTotalReserved}</p>
                            <p class="kpi-card__label">Reserved</p>
                        </div>
                    </div>
                </div>

                <!-- Available -->
                <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-3 slds-large-size_1-of-6 slds-p-bottom_small">
                    <div class="kpi-card kpi-card_default">
                        <div class="kpi-card__icon">
                            <lightning-icon icon-name="standard:product_consumed" size="small"></lightning-icon>
                        </div>
                        <div class="kpi-card__content">
                            <p class="kpi-card__value">{kpiTotalAvailable}</p>
                            <p class="kpi-card__label">Available</p>
                        </div>
                    </div>
                </div>

                <!-- Low Stock -->
                <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-3 slds-large-size_1-of-6 slds-p-bottom_small">
                    <div class={kpiLowStockClass}>
                        <div class="kpi-card__icon">
                            <lightning-icon icon-name="utility:warning" size="small" variant={kpiLowStockIconVariant}></lightning-icon>
                        </div>
                        <div class="kpi-card__content">
                            <p class="kpi-card__value">{kpiLowStockCount}</p>
                            <p class="kpi-card__label">Low Stock</p>
                        </div>
                    </div>
                </div>

                <!-- Zero Stock -->
                <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-3 slds-large-size_1-of-6 slds-p-bottom_small">
                    <div class={kpiZeroStockClass}>
                        <div class="kpi-card__icon">
                            <lightning-icon icon-name="utility:error" size="small" variant={kpiZeroStockIconVariant}></lightning-icon>
                        </div>
                        <div class="kpi-card__content">
                            <p class="kpi-card__value">{kpiZeroStockCount}</p>
                            <p class="kpi-card__label">Zero Stock</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Banner -->
            <template if:true={errorMessage}>
                <div class="slds-notify slds-notify_alert slds-alert_error slds-m-bottom_medium" role="alert">
                    <span class="slds-assistive-text">error</span>
                    <lightning-icon icon-name="utility:error" size="x-small" variant="inverse" class="slds-m-right_x-small"></lightning-icon>
                    <h2>{errorMessage}</h2>
                </div>
            </template>

            <!-- Tabset -->
            <lightning-tabset variant="scoped" active-tab-value={activeTab} onactive={handleTabChange}>

                <!-- Tab 1: Current Stock -->
                <lightning-tab label="Current Stock" value="currentStock" icon-name="standard:product_item">
                    <div class="slds-p-top_small">
                        <!-- Filter Bar -->
                        <div class="slds-grid slds-grid_vertical-align-end slds-gutters_small slds-wrap slds-m-bottom_small">
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_4-of-12 slds-p-bottom_x-small">
                                <lightning-input
                                    type="search"
                                    label="Search Product"
                                    placeholder="Search by product name or code..."
                                    value={productSearch}
                                    onchange={handleProductSearch}
                                ></lightning-input>
                            </div>
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_8-of-12 slds-p-bottom_x-small">
                                <div class="slds-form-element">
                                    <label class="slds-form-element__label">Stock Filter</label>
                                    <div class="slds-form-element__control">
                                        <lightning-button-group>
                                            <lightning-button label="All" variant={filterAllVariant} onclick={handleStockFilterAll}></lightning-button>
                                            <lightning-button label="Low Stock" variant={filterLowVariant} onclick={handleStockFilterLow} icon-name="utility:warning"></lightning-button>
                                            <lightning-button label="Zero Stock" variant={filterZeroVariant} onclick={handleStockFilterZero} icon-name="utility:error"></lightning-button>
                                            <lightning-button label="Healthy" variant={filterHealthyVariant} onclick={handleStockFilterHealthy} icon-name="utility:success"></lightning-button>
                                        </lightning-button-group>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stock Data Table -->
                        <template if:true={hasStockRecords}>
                            <div class="table-container">
                                <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_striped">
                                    <thead>
                                        <tr class="slds-line-height_reset">
                                            <th scope="col"><div class="slds-truncate" title="Stock #">Stock #</div></th>
                                            <th scope="col"><div class="slds-truncate" title="Warehouse">Warehouse</div></th>
                                            <th scope="col"><div class="slds-truncate" title="Product">Product</div></th>
                                            <th scope="col"><div class="slds-truncate" title="Code">Code</div></th>
                                            <th scope="col" class="slds-text-align_right"><div class="slds-truncate" title="On Hand">On Hand</div></th>
                                            <th scope="col" class="slds-text-align_right"><div class="slds-truncate" title="Reserved">Reserved</div></th>
                                            <th scope="col" class="slds-text-align_right"><div class="slds-truncate" title="Available">Available</div></th>
                                            <th scope="col" class="slds-text-align_right"><div class="slds-truncate" title="Damaged">Damaged</div></th>
                                            <th scope="col"><div class="slds-truncate" title="Batch">Batch</div></th>
                                            <th scope="col"><div class="slds-truncate" title="Expiry">Expiry</div></th>
                                            <th scope="col"><div class="slds-truncate" title="Last Txn">Last Txn</div></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template for:each={stockTableRows} for:item="row">
                                            <tr key={row.id}>
                                                <td><div class="slds-truncate">{row.name}</div></td>
                                                <td><div class="slds-truncate">{row.warehouseName}</div></td>
                                                <td><div class="slds-truncate">{row.productName}</div></td>
                                                <td><div class="slds-truncate">{row.productCode}</div></td>
                                                <td class="slds-text-align_right">{row.onHand}</td>
                                                <td class="slds-text-align_right">{row.reserved}</td>
                                                <td class="slds-text-align_right">
                                                    <span class={row.availableClass}><strong>{row.available}</strong></span>
                                                </td>
                                                <td class="slds-text-align_right">{row.damaged}</td>
                                                <td><div class="slds-truncate">{row.batchNumber}</div></td>
                                                <td>{row.expiryDate}</td>
                                                <td>{row.lastTransaction}</td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </template>

                        <template if:false={hasStockRecords}>
                            <div class="slds-illustration slds-illustration_small slds-p-around_large slds-text-align_center">
                                <p class="slds-text-body_regular slds-text-color_weak">No warehouse stock records found matching the current filters.</p>
                            </div>
                        </template>

                        <!-- Pagination -->
                        <template if:true={hasStockRecords}>
                            <div class="slds-grid slds-grid_align-center slds-grid_vertical-align-center slds-p-top_small">
                                <div class="slds-col">
                                    <lightning-button label="Previous" icon-name="utility:chevronleft" onclick={handlePreviousPage} disabled={isPreviousDisabled} variant="neutral"></lightning-button>
                                </div>
                                <div class="slds-col slds-p-horizontal_medium">
                                    <span class="slds-text-body_small">Page {currentPage} of {totalPages} ({stockTotalCount} records)</span>
                                </div>
                                <div class="slds-col">
                                    <lightning-button label="Next" icon-name="utility:chevronright" icon-position="right" onclick={handleNextPage} disabled={isNextDisabled} variant="neutral"></lightning-button>
                                </div>
                            </div>
                        </template>
                    </div>
                </lightning-tab>

                <!-- Tab 2: Transaction Log -->
                <lightning-tab label="Transaction Log" value="transactions" icon-name="utility:activity">
                    <div class="slds-p-top_small">
                        <template if:true={hasTransactionRecords}>
                            <div class="table-container">
                                <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_striped">
                                    <thead>
                                        <tr class="slds-line-height_reset">
                                            <th scope="col"><div class="slds-truncate" title="Txn #">Txn #</div></th>
                                            <th scope="col"><div class="slds-truncate" title="Date">Date</div></th>
                                            <th scope="col"><div class="slds-truncate" title="Type">Type</div></th>
                                            <th scope="col"><div class="slds-truncate" title="Product">Product</div></th>
                                            <th scope="col" class="slds-text-align_right"><div class="slds-truncate" title="Qty">Qty</div></th>
                                            <th scope="col"><div class="slds-truncate" title="Direction">Dir</div></th>
                                            <th scope="col" class="slds-text-align_right"><div class="slds-truncate" title="Balance">Balance</div></th>
                                            <th scope="col"><div class="slds-truncate" title="Reference">Reference</div></th>
                                            <th scope="col"><div class="slds-truncate" title="By">By</div></th>
                                            <th scope="col"><div class="slds-truncate" title="Notes">Notes</div></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template for:each={transactionTableRows} for:item="row">
                                            <tr key={row.id}>
                                                <td><div class="slds-truncate">{row.name}</div></td>
                                                <td>{row.txnDate}</td>
                                                <td><div class="slds-truncate">{row.txnType}</div></td>
                                                <td><div class="slds-truncate">{row.productName}</div></td>
                                                <td class="slds-text-align_right">
                                                    <span class={row.directionClass}>{row.directionIcon}{row.quantity}</span>
                                                </td>
                                                <td>
                                                    <lightning-badge label={row.direction}></lightning-badge>
                                                </td>
                                                <td class="slds-text-align_right">{row.runningBalance}</td>
                                                <td><div class="slds-truncate">{row.refType}</div></td>
                                                <td><div class="slds-truncate">{row.txnBy}</div></td>
                                                <td><div class="slds-truncate">{row.notes}</div></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </template>

                        <template if:true={showTransactionPlaceholder}>
                            <div class="slds-illustration slds-illustration_small slds-p-around_large slds-text-align_center">
                                <p class="slds-text-body_regular slds-text-color_weak">Loading transaction log...</p>
                            </div>
                        </template>

                        <template if:true={showTransactionEmpty}>
                            <div class="slds-illustration slds-illustration_small slds-p-around_large slds-text-align_center">
                                <p class="slds-text-body_regular slds-text-color_weak">No stock transactions found for this warehouse.</p>
                            </div>
                        </template>
                    </div>
                </lightning-tab>

                <!-- Tab 3: Low Stock Alerts -->
                <lightning-tab label="Low Stock Alerts" value="lowStock" icon-name="utility:warning">
                    <div class="slds-p-top_small">
                        <template if:true={hasLowStockRecords}>
                            <div class="table-container">
                                <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_striped">
                                    <thead>
                                        <tr class="slds-line-height_reset">
                                            <th scope="col"><div class="slds-truncate" title="Severity">Severity</div></th>
                                            <th scope="col"><div class="slds-truncate" title="Warehouse">Warehouse</div></th>
                                            <th scope="col"><div class="slds-truncate" title="Product">Product</div></th>
                                            <th scope="col"><div class="slds-truncate" title="Code">Code</div></th>
                                            <th scope="col" class="slds-text-align_right"><div class="slds-truncate" title="On Hand">On Hand</div></th>
                                            <th scope="col" class="slds-text-align_right"><div class="slds-truncate" title="Reserved">Reserved</div></th>
                                            <th scope="col" class="slds-text-align_right"><div class="slds-truncate" title="Available">Available</div></th>
                                            <th scope="col" class="slds-text-align_right"><div class="slds-truncate" title="Min Level">Min Level</div></th>
                                            <th scope="col" class="slds-text-align_right"><div class="slds-truncate" title="Reorder Qty">Reorder Qty</div></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template for:each={lowStockTableRows} for:item="row">
                                            <tr key={row.id}>
                                                <td>
                                                    <lightning-badge label={row.severity} class={row.severityClass}></lightning-badge>
                                                </td>
                                                <td><div class="slds-truncate">{row.warehouseName}</div></td>
                                                <td><div class="slds-truncate">{row.productName}</div></td>
                                                <td><div class="slds-truncate">{row.productCode}</div></td>
                                                <td class="slds-text-align_right">{row.onHand}</td>
                                                <td class="slds-text-align_right">{row.reserved}</td>
                                                <td class="slds-text-align_right">
                                                    <span class={row.availableClass}><strong>{row.available}</strong></span>
                                                </td>
                                                <td class="slds-text-align_right">{row.minLevel}</td>
                                                <td class="slds-text-align_right"><strong>{row.reorderQty}</strong></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </template>

                        <template if:true={showLowStockEmpty}>
                            <div class="slds-illustration slds-illustration_small slds-p-around_large slds-text-align_center">
                                <p class="slds-text-body_regular slds-text-color_weak">No low stock alerts. All stock levels are healthy.</p>
                            </div>
                        </template>
                    </div>
                </lightning-tab>
            </lightning-tabset>
        </div>
    </lightning-card>
</template>
